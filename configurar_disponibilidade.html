<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuração de Agenda - Clínica Estética</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    
    .container {
      display: flex;
      gap: 30px;
      margin-top: 20px;
    }
    
    .controls {
      width: 300px;
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
    }
    
    .controls h2 {
      margin-top: 20px;
      color: #333;
      font-size: 16px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    
    .controls label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    
    .controls select, .controls input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .controls button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    .controls button:hover {
      background: #45a049;
    }
    
    #calendar {
      flex: 1;
    }
    
    /* Estilos para os diferentes tipos de eventos */
    .disponibilidade {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .intervalo {
      background-color: #ff9800 !important;
      border-color: #ff9800 !important;
    }
    
    .excecao {
      background-color: #f44336 !important;
      border-color: #f44336 !important;
    }
    
    .slot-disponivel {
      background-color: #2196F3 !important;
      border-color: #2196F3 !important;
      font-size: 12px;
      padding: 2px !important;
      margin: 1px !important;
    }
    
    .slot-label {
      font-size: 10px;
      opacity: 0.9;
    }
    
    .slot-controls {
      background: #e8f5e9;
      padding: 15px;
      margin-top: 20px;
      border-radius: 6px;
      border: 1px solid #c8e6c9;
    }
    
    .btn-danger {
      background: #f44336 !important;
    }
    
    .btn-danger:hover {
      background: #d32f2f !important;
    }
  </style>
</head>
<body>
  <h1>Configuração de Agenda - Clínica Estética</h1>
  <div class="container">
    <div class="controls">
      <div class="slot-controls">
        <h2>Configuração de Lacunas/Slots</h2>
        <label>Duração do Slot (minutos):</label>
        <select id="duracaoSlot">
          <option value="30">30 minutos</option>
          <option value="60">60 minutos</option>
          <option value="90">90 minutos</option>
          <option value="120">120 minutos</option>
        </select>
        
        <!-- Botão Gerar Slots com Formulário -->
        <form method="POST" action="php/agenda_controller.php" id="formGerarSlots" style="display: inline;">
          <input type="hidden" name="action" value="gerar_slots">
          <input type="hidden" name="duracao" id="hiddenDuracao">
          <button type="button" onclick="gerarSlots()" style="margin-bottom: 10px;">Gerar Slots de Horários</button>
        </form>
        
        <!-- Botão Limpar Slots com Formulário -->
        <form method="POST" action="php/agenda_controller.php" style="display: inline;">
          <input type="hidden" name="action" value="limpar_slots">
          <button type="button" onclick="limparSlots()" style="background: #757575;">Limpar Slots</button>
        </form>
        
        <p><small>Slots são gerados dentro das disponibilidades, exceto nos intervalos e exceções.</small></p>
      </div>

      <h2>Disponibilidade</h2>
      <label>Dia da semana:</label>
      <select id="diaSemanaDisponibilidade">
        <option value="1">Segunda-feira</option>
        <option value="2">Terça-feira</option>
        <option value="3">Quarta-feira</option>
        <option value="4">Quinta-feira</option>
        <option value="5">Sexta-feira</option>
        <option value="6">Sábado</option>
      </select>
      <label>Hora Início:</label>
      <input type="time" id="horaInicioDisponibilidade">
      <label>Hora Fim:</label>
      <input type="time" id="horaFimDisponibilidade">
      
      <!-- Formulário para Disponibilidade -->
      <form method="POST" action="php/agenda_controller.php" id="formDisponibilidade" style="display: none;">
        <input type="hidden" name="action" value="salvar_config">
        <input type="hidden" name="tipo" value="disponibilidade">
        <input type="hidden" name="dia_semana" id="hiddenDiaDisponibilidade">
        <input type="hidden" name="horario_inicio" id="hiddenInicioDisponibilidade">
        <input type="hidden" name="horario_fim" id="hiddenFimDisponibilidade">
      </form>
      <button type="button" onclick="salvarDisponibilidade()">Adicionar/Alterar</button>

      <h2>Intervalo Fixo</h2>
      <label>Dia da semana:</label>
      <select id="diaSemanaIntervalo">
        <option value="1">Segunda-feira</option>
        <option value="2">Terça-feira</option>
        <option value="3">Quarta-feira</option>
        <option value="4">Quinta-feira</option>
        <option value="5">Sexta-feira</option>
        <option value="6">Sábado</option>
      </select>
      <label>Hora Início:</label>
      <input type="time" id="horaInicioIntervalo">
      <label>Hora Fim:</label>
      <input type="time" id="horaFimIntervalo">
      
      <!-- Formulário para Intervalo -->
      <form method="POST" action="php/agenda_controller.php" id="formIntervalo" style="display: none;">
        <input type="hidden" name="action" value="salvar_config">
        <input type="hidden" name="tipo" value="intervalo">
        <input type="hidden" name="dia_semana" id="hiddenDiaIntervalo">
        <input type="hidden" name="horario_inicio" id="hiddenInicioIntervalo">
        <input type="hidden" name="horario_fim" id="hiddenFimIntervalo">
      </form>
      <button type="button" onclick="salvarIntervalo()">Adicionar/Alterar</button>

      <h2>Exceções</h2>
      <label>Data:</label>
      <input type="date" id="dataExcecao">
      <label>Hora Início (opcional):</label>
      <input type="time" id="horaInicioExcecao">
      <label>Hora Fim (opcional):</label>
      <input type="time" id="horaFimExcecao">
      <label>Motivo:</label>
      <input type="text" id="motivoExcecao" placeholder="Ex: Feriado">
      
      <!-- Formulário para Exceção -->
      <form method="POST" action="php/agenda_controller.php" id="formExcecao" style="display: none;">
        <input type="hidden" name="action" value="salvar_excecao">
        <input type="hidden" name="data_excecao" id="hiddenDataExcecao">
        <input type="hidden" name="horario_inicio" id="hiddenInicioExcecao">
        <input type="hidden" name="horario_fim" id="hiddenFimExcecao">
        <input type="hidden" name="motivo" id="hiddenMotivoExcecao">
      </form>
      <button type="button" onclick="salvarExcecao()">Adicionar Exceção</button>
    </div>
    <div id="calendar"></div>
  </div>

  <!-- Script para carregar dados do banco -->
  <script src="php/carregar_dados.php?tipo=disponibilidade"></script>
  <script src="php/carregar_dados.php?tipo=intervalo"></script>
  <script src="php/carregar_dados.php?tipo=excecoes"></script>

  <script>
    // Variáveis globais que serão preenchidas pelos scripts acima
    let disponibilidades = window.disponibilidades || [];
    let intervalos = window.intervalos || [];
    let excecoes = window.excecoes || [];
    let slots = [];

    document.addEventListener('DOMContentLoaded', function() {
      // Configura data atual no campo de exceção
      const hoje = new Date();
      document.getElementById('dataExcecao').value = hoje.toISOString().split('T')[0];
      
      // Inicializa o calendário
      window.calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'timeGridWeek',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'pt-br',
        editable: true,
        selectable: true,
        slotDuration: '00:30:00',
        slotLabelInterval: '01:00',
        allDaySlot: false,
        slotMinTime: '06:00:00',
        slotMaxTime: '20:00:00',
        eventClick: function(info) {
          if(info.event.extendedProps.tipo === 'excecao'){
            if(confirm('Deseja excluir esta exceção?')){
              excluirExcecao(info.event.id);
            }
          }
        },
        events: []
      });
      window.calendar.render();
      
      // Atualiza os eventos no calendário
      atualizarEventos();
    });

    // ========== FUNÇÕES PARA SALVAR NO BANCO ==========

    function salvarDisponibilidade() {
      const dia = document.getElementById('diaSemanaDisponibilidade').value;
      const inicio = document.getElementById('horaInicioDisponibilidade').value;
      const fim = document.getElementById('horaFimDisponibilidade').value;
      
      if(!inicio || !fim) {
        alert('Preencha horários.');
        return;
      }
      
      // Preenche o formulário hidden
      document.getElementById('hiddenDiaDisponibilidade').value = dia;
      document.getElementById('hiddenInicioDisponibilidade').value = inicio + ':00';
      document.getElementById('hiddenFimDisponibilidade').value = fim + ':00';
      
      // Confirma e envia
      if(confirm(`Salvar disponibilidade para ${getNomeDia(dia)} das ${inicio} às ${fim}?`)) {
        document.getElementById('formDisponibilidade').submit();
      }
    }

    function salvarIntervalo() {
      const dia = document.getElementById('diaSemanaIntervalo').value;
      const inicio = document.getElementById('horaInicioIntervalo').value;
      const fim = document.getElementById('horaFimIntervalo').value;
      
      if(!inicio || !fim) {
        alert('Preencha horários.');
        return;
      }
      
      document.getElementById('hiddenDiaIntervalo').value = dia;
      document.getElementById('hiddenInicioIntervalo').value = inicio + ':00';
      document.getElementById('hiddenFimIntervalo').value = fim + ':00';
      
      if(confirm(`Salvar intervalo para ${getNomeDia(dia)} das ${inicio} às ${fim}?`)) {
        document.getElementById('formIntervalo').submit();
      }
    }

    function salvarExcecao() {
      const data = document.getElementById('dataExcecao').value;
      const inicio = document.getElementById('horaInicioExcecao').value;
      const fim = document.getElementById('horaFimExcecao').value;
      const motivo = document.getElementById('motivoExcecao').value || 'Sem atendimento';
      
      if(!data) {
        alert('Selecione uma data.');
        return;
      }
      
      document.getElementById('hiddenDataExcecao').value = data;
      document.getElementById('hiddenInicioExcecao').value = inicio ? inicio + ':00' : '';
      document.getElementById('hiddenFimExcecao').value = fim ? fim + ':00' : '';
      document.getElementById('hiddenMotivoExcecao').value = motivo;
      
      let mensagem = `Salvar exceção para ${formatarData(data)}?\nMotivo: ${motivo}`;
      if(inicio && fim) {
        mensagem += `\nHorário: ${inicio} às ${fim}`;
      }
      
      if(confirm(mensagem)) {
        document.getElementById('formExcecao').submit();
      }
    }

    function excluirExcecao(idExcecao) {
      if(!confirm('Tem certeza que deseja excluir esta exceção?')) return;
      
      // Cria formulário dinâmico para exclusão
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'php/agenda_controller.php';
      form.style.display = 'none';
      
      const inputAction = document.createElement('input');
      inputAction.type = 'hidden';
      inputAction.name = 'action';
      inputAction.value = 'excluir_excecao';
      
      const inputId = document.createElement('input');
      inputId.type = 'hidden';
      inputId.name = 'id_excecao';
      inputId.value = idExcecao;
      
      form.appendChild(inputAction);
      form.appendChild(inputId);
      document.body.appendChild(form);
      form.submit();
    }

    function gerarSlots() {
      const duracao = document.getElementById('duracaoSlot').value;
      document.getElementById('hiddenDuracao').value = duracao;
      
      if(confirm(`Gerar slots de ${duracao} minutos para os próximos 60 dias?`)) {
        document.getElementById('formGerarSlots').submit();
      }
    }

    function limparSlots() {
      if(!confirm('Limpar todos os slots disponíveis?\nIsso não afeta agendamentos já confirmados.')) {
        return;
      }
      
      // Cria formulário dinâmico
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'php/agenda_controller.php';
      form.style.display = 'none';
      
      const inputAction = document.createElement('input');
      inputAction.type = 'hidden';
      inputAction.name = 'action';
      inputAction.value = 'limpar_slots';
      
      form.appendChild(inputAction);
      document.body.appendChild(form);
      form.submit();
    }

    // ========== FUNÇÕES DO CALENDÁRIO ==========

    function atualizarEventos(){
      if (!window.calendar) return;
      
      window.calendar.removeAllEvents();

      // Adiciona disponibilidades
      disponibilidades.forEach(d => {
        let dia = parseInt(d.dia_semana);
        let excecaoNoDia = excecoes.some(e => new Date(e.data_excecao).getDay() === dia);
        if(!excecaoNoDia){
          window.calendar.addEvent({
            daysOfWeek:[dia],
            startTime:d.horario_inicio,
            endTime:d.horario_fim,
            title:'Disponível',
            className:'disponibilidade',
            tipo:'disponibilidade'
          });
        }
      });

      // Adiciona intervalos
      intervalos.forEach(i => {
        let dia = parseInt(i.dia_semana);
        window.calendar.addEvent({
          daysOfWeek:[dia],
          startTime:i.horario_inicio,
          endTime:i.horario_fim,
          title:'Intervalo',
          className:'intervalo',
          tipo:'intervalo'
        });
      });

      // Adiciona exceções
      excecoes.forEach(e => {
        window.calendar.addEvent({
          id:e.id_excecao,
          start:e.horario_inicio ? `${e.data_excecao}T${e.horario_inicio}` : `${e.data_excecao}T00:00`,
          end:e.horario_fim ? `${e.data_excecao}T${e.horario_fim}` : `${e.data_excecao}T23:59`,
          title:'Exceção',
          className:'excecao',
          tipo:'excecao'
        });
      });

      // Adiciona slots (se estiverem carregados)
      slots.forEach(slot => {
        window.calendar.addEvent({
          daysOfWeek:[slot.diaSemana],
          startTime:slot.inicio,
          endTime:slot.fim,
          title:`Slot: ${slot.inicio} - ${slot.fim}`,
          className:'slot-disponivel',
          tipo:'slot'
        });
      });
    }

    // ========== FUNÇÕES AUXILIARES ==========

    function getNomeDia(numero) {
      const dias = {
        '1': 'Segunda-feira',
        '2': 'Terça-feira',
        '3': 'Quarta-feira',
        '4': 'Quinta-feira',
        '5': 'Sexta-feira',
        '6': 'Sábado',
        '7': 'Domingo'
      };
      return dias[numero] || 'Dia ' + numero;
    }

    function formatarData(dataStr) {
      const data = new Date(dataStr);
      return data.toLocaleDateString('pt-BR');
    }

    // Funções auxiliares para trabalhar com horários (mantidas da versão original)
    function timeToMinutes(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function minutesToTime(minutes) {
      const hours = Math.floor(minutes / 60).toString().padStart(2, '0');
      const mins = (minutes % 60).toString().padStart(2, '0');
      return `${hours}:${mins}`;
    }
  </script>
</body>
</html>
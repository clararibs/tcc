<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuração de Agenda - Clínica Estética</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    
    .container {
      display: flex;
      gap: 30px;
      margin-top: 20px;
    }
    
    .controls {
      width: 300px;
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
    }
    
    .controls h2 {
      margin-top: 20px;
      color: #333;
      font-size: 16px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    
    .controls label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    
    .controls select, .controls input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .controls button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    .controls button:hover {
      background: #45a049;
    }
    
    #calendar {
      flex: 1;
    }
    
    /* Estilos para os diferentes tipos de eventos */
    .disponibilidade {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .intervalo {
      background-color: #ff9800 !important;
      border-color: #ff9800 !important;
    }
    
    .excecao {
      background-color: #f44336 !important;
      border-color: #f44336 !important;
    }
    
    .slot-disponivel {
      background-color: #2196F3 !important;
      border-color: #2196F3 !important;
      font-size: 12px;
      padding: 2px !important;
      margin: 1px !important;
    }
    
    .slot-label {
      font-size: 10px;
      opacity: 0.9;
    }
    
    .slot-controls {
      background: #e8f5e9;
      padding: 15px;
      margin-top: 20px;
      border-radius: 6px;
      border: 1px solid #c8e6c9;
    }
    
    .btn-danger {
      background: #f44336 !important;
    }
    
    .btn-danger:hover {
      background: #d32f2f !important;
    }
  </style>
</head>
<body>
  <h1>Configuração de Agenda - Clínica Estética</h1>
  
  <div class="status-bar" style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
    <strong>Status:</strong> Carregando configurações...
  </div>
  
  <div class="container">
    <div class="controls">
      <div class="slot-controls">
        <h2>Configuração de Lacunas/Slots</h2>
        <label>Duração do Slot (minutos):</label>
        <select id="duracaoSlot">
          <option value="30">30 minutos</option>
          <option value="60" selected>60 minutos</option>
          <option value="90">90 minutos</option>
          <option value="120">120 minutos</option>
        </select>
        
        <!-- Botão Gerar Slots com Formulário -->
        <form method="POST" action="agenda_controller.php" id="formGerarSlots" style="display: inline;">
          <input type="hidden" name="action" value="gerar_slots">
          <input type="hidden" name="duracao" id="hiddenDuracao">
          <button type="button" onclick="gerarSlots()" style="margin-bottom: 10px;">Gerar Slots de Horários</button>
        </form>
        
        <!-- Botão Limpar Slots com Formulário -->
        <form method="POST" action="agenda_controller.php" style="display: inline;">
          <input type="hidden" name="action" value="limpar_slots">
          <button type="button" onclick="limparSlots()" style="background: #757575;">Limpar Slots</button>
        </form>
        
        <p><small>Slots são gerados dentro das disponibilidades, exceto nos intervalos e exceções.</small></p>
      </div>

      <h2>Disponibilidade</h2>
      <label>Dia da semana:</label>
      <select id="diaSemanaDisponibilidade">
        <option value="">Selecione um dia</option>
        <option value="segunda">Segunda-feira</option>
        <option value="terca">Terça-feira</option>
        <option value="quarta">Quarta-feira</option>
        <option value="quinta">Quinta-feira</option>
        <option value="sexta">Sexta-feira</option>
        <option value="sabado">Sábado</option>
      </select>
      <label>Hora Início:</label>
      <input type="time" id="horaInicioDisponibilidade">
      <label>Hora Fim:</label>
      <input type="time" id="horaFimDisponibilidade">
      
      <!-- Formulário para Disponibilidade -->
      <form method="POST" action="agenda_controller.php" id="formDisponibilidade" style="display: none;">
        <input type="hidden" name="action" value="salvar_config">
        <input type="hidden" name="tipo" value="disponibilidade">
        <input type="hidden" name="dia_semana" id="hiddenDiaDisponibilidade">
        <input type="hidden" name="horario_inicio" id="hiddenInicioDisponibilidade">
        <input type="hidden" name="horario_fim" id="hiddenFimDisponibilidade">
      </form>
      <button type="button" onclick="salvarDisponibilidade()">Adicionar/Alterar</button>

      <h2>Intervalo Fixo</h2>
      <label>Dia da semana:</label>
      <select id="diaSemanaIntervalo">
        <option value="">Selecione um dia</option>
        <option value="segunda">Segunda-feira</option>
        <option value="terca">Terça-feira</option>
        <option value="quarta">Quarta-feira</option>
        <option value="quinta">Quinta-feira</option>
        <option value="sexta">Sexta-feira</option>
        <option value="sabado">Sábado</option>
      </select>
      <label>Hora Início:</label>
      <input type="time" id="horaInicioIntervalo">
      <label>Hora Fim:</label>
      <input type="time" id="horaFimIntervalo">
      
      <!-- Formulário para Intervalo -->
      <form method="POST" action="agenda_controller.php" id="formIntervalo" style="display: none;">
        <input type="hidden" name="action" value="salvar_config">
        <input type="hidden" name="tipo" value="intervalo">
        <input type="hidden" name="dia_semana" id="hiddenDiaIntervalo">
        <input type="hidden" name="horario_inicio" id="hiddenInicioIntervalo">
        <input type="hidden" name="horario_fim" id="hiddenFimIntervalo">
      </form>
      <button type="button" onclick="salvarIntervalo()">Adicionar/Alterar</button>

      <h2>Exceções</h2>
      <label>Data:</label>
      <input type="date" id="dataExcecao">
      <label>Hora Início (opcional):</label>
      <input type="time" id="horaInicioExcecao">
      <label>Hora Fim (opcional):</label>
      <input type="time" id="horaFimExcecao">
      <label>Motivo:</label>
      <input type="text" id="motivoExcecao" placeholder="Ex: Feriado">
      
      <!-- Formulário para Exceção -->
      <form method="POST" action="agenda_controller.php" id="formExcecao" style="display: none;">
        <input type="hidden" name="action" value="salvar_excecao">
        <input type="hidden" name="data_excecao" id="hiddenDataExcecao">
        <input type="hidden" name="horario_inicio" id="hiddenInicioExcecao">
        <input type="hidden" name="horario_fim" id="hiddenFimExcecao">
        <input type="hidden" name="motivo" id="hiddenMotivoExcecao">
      </form>
      <button type="button" onclick="salvarExcecao()">Adicionar Exceção</button>
    </div>
    <div id="calendar"></div>
  </div>

  <script>
    // Variáveis globais
    let disponibilidades = [];
    let intervalos = [];
    let excecoes = [];
    let slots = [];
    let calendar;

    document.addEventListener('DOMContentLoaded', function() {
      // Configura data atual no campo de exceção
      const hoje = new Date();
      document.getElementById('dataExcecao').value = hoje.toISOString().split('T')[0];
      
      // Inicializa o calendário primeiro
      inicializarCalendario();
      
      // Depois carrega os dados
      carregarDadosIniciais();
    });

    // ========== CARREGAR DADOS ==========

    async function carregarDadosIniciais() {
      try {
        // Carrega disponibilidades
        const response1 = await fetch('carregar_dados.php?tipo=disponibilidade&_=' + Date.now());
        const disponibilidadeData = await response1.text();
        disponibilidades = extrairDadosDeScript(disponibilidadeData) || [];
        
        // Carrega intervalos
        const response2 = await fetch('carregar_dados.php?tipo=intervalo&_=' + Date.now());
        const intervaloData = await response2.text();
        intervalos = extrairDadosDeScript(intervaloData) || [];
        
        // Carrega exceções
        const response3 = await fetch('carregar_dados.php?tipo=excecoes&_=' + Date.now());
        const excecaoData = await response3.text();
        excecoes = extrairDadosDeScript(excecaoData) || [];
        
        console.log('Dados carregados:', { disponibilidades, intervalos, excecoes });
        
        // Atualiza status
        document.querySelector('.status-bar').innerHTML = 
          `<strong>Status:</strong> ${disponibilidades.length} disponibilidades, ${intervalos.length} intervalos, ${excecoes.length} exceções carregadas`;
        
        // Atualiza os eventos no calendário
        atualizarEventosCalendario();
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        document.querySelector('.status-bar').innerHTML = 
          `<strong>Erro:</strong> Não foi possível carregar configurações. Tente recarregar a página.`;
      }
    }

    function extrairDadosDeScript(scriptContent) {
      // Procura por window.nomeArray = [...];
      const match = scriptContent.match(/window\.\w+\s*=\s*(\[.*?\])/s);
      if (match) {
        try {
          // Remove comentários e eval
          const cleanScript = match[1].replace(/\n/g, '');
          return eval('(' + cleanScript + ')');
        } catch (e) {
          console.error('Erro ao parsear dados:', e);
          return [];
        }
      }
      return [];
    }

    // ========== INICIALIZAR CALENDÁRIO ==========

    function inicializarCalendario() {
      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'timeGridWeek',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'pt-br',
        editable: false,
        selectable: false,
        slotDuration: '00:30:00',
        slotLabelInterval: '01:00',
        allDaySlot: false,
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        height: 650,
        events: [],
        eventClick: function(info) {
          if(info.event.extendedProps.tipo === 'excecao'){
            if(confirm('Deseja excluir esta exceção?')){
              excluirExcecao(info.event.id);
            }
          }
        }
      });
      
      calendar.render();
    }

    function atualizarEventosCalendario() {
      if (!calendar) return;
      
      calendar.removeAllEvents();
      const eventos = [];
      
      // Mapeia dias da semana para números do FullCalendar (0=Domingo, 1=Segunda...)
      const diasMap = {
        'segunda': 1,
        'terca': 2,
        'quarta': 3,
        'quinta': 4,
        'sexta': 5,
        'sabado': 6,
        'domingo': 0
      };
      
      // Adiciona disponibilidades
      disponibilidades.forEach(d => {
        const diaNumero = diasMap[d.dia_semana.toLowerCase()] || parseInt(d.dia_semana);
        const inicio = d.horario_inicio.substring(0, 5); // Pega apenas HH:MM
        const fim = d.horario_fim.substring(0, 5);
        
        eventos.push({
          daysOfWeek: [diaNumero],
          startTime: inicio,
          endTime: fim,
          title: `Disponível (${inicio} - ${fim})`,
          className: 'disponibilidade',
          tipo: 'disponibilidade',
          color: '#4CAF50'
        });
      });
      
      // Adiciona intervalos
      intervalos.forEach(i => {
        const diaNumero = diasMap[i.dia_semana.toLowerCase()] || parseInt(i.dia_semana);
        const inicio = i.horario_inicio.substring(0, 5);
        const fim = i.horario_fim.substring(0, 5);
        
        eventos.push({
          daysOfWeek: [diaNumero],
          startTime: inicio,
          endTime: fim,
          title: `Intervalo (${inicio} - ${fim})`,
          className: 'intervalo',
          tipo: 'intervalo',
          color: '#ff9800'
        });
      });
      
      // Adiciona exceções
      excecoes.forEach(e => {
        const isTodoDia = !e.horario_inicio && !e.horario_fim;
        const inicio = e.horario_inicio ? e.horario_inicio.substring(0, 5) : '';
        const fim = e.horario_fim ? e.horario_fim.substring(0, 5) : '';
        
        eventos.push({
          id: e.id_excecao.toString(),
          start: isTodoDia ? e.data_excecao : `${e.data_excecao}T${inicio}`,
          end: isTodoDia ? e.data_excecao : `${e.data_excecao}T${fim}`,
          title: `Exceção: ${e.motivo}` + (isTodoDia ? '' : ` (${inicio} - ${fim})`),
          className: 'excecao',
          tipo: 'excecao',
          color: '#f44336',
          allDay: isTodoDia
        });
      });
      
      // Adiciona todos os eventos
      eventos.forEach(evento => calendar.addEvent(evento));
      
      // Atualiza o calendário
      calendar.render();
    }

    // ========== VALIDAÇÕES ==========

    function validarHorario(idInicio, idFim) {
      const inicio = document.getElementById(idInicio).value;
      const fim = document.getElementById(idFim).value;
      
      if (inicio && fim && inicio >= fim) {
        alert('A hora de início deve ser anterior à hora de fim.');
        return false;
      }
      return true;
    }

    // ========== FUNÇÕES PARA SALVAR ==========

    function salvarDisponibilidade() {
      const dia = document.getElementById('diaSemanaDisponibilidade').value;
      const inicio = document.getElementById('horaInicioDisponibilidade').value;
      const fim = document.getElementById('horaFimDisponibilidade').value;
      
      // Validações
      if (!dia) {
        alert('Por favor, selecione um dia da semana.');
        return;
      }
      
      if (!inicio || !fim) {
        alert('Por favor, preencha ambos os horários.');
        return;
      }
      
      if (!validarHorario('horaInicioDisponibilidade', 'horaFimDisponibilidade')) {
        return;
      }
      
      // Preenche o formulário hidden
      document.getElementById('hiddenDiaDisponibilidade').value = dia;
      document.getElementById('hiddenInicioDisponibilidade').value = inicio + ':00';
      document.getElementById('hiddenFimDisponibilidade').value = fim + ':00';
      
      // Confirma e envia
      if (confirm(`Salvar disponibilidade para ${getNomeDia(dia)} das ${inicio} às ${fim}?`)) {
        document.getElementById('formDisponibilidade').submit();
      }
    }

    function salvarIntervalo() {
      const dia = document.getElementById('diaSemanaIntervalo').value;
      const inicio = document.getElementById('horaInicioIntervalo').value;
      const fim = document.getElementById('horaFimIntervalo').value;
      
      // Validações
      if (!dia) {
        alert('Por favor, selecione um dia da semana.');
        return;
      }
      
      if (!inicio || !fim) {
        alert('Por favor, preencha ambos os horários.');
        return;
      }
      
      if (!validarHorario('horaInicioIntervalo', 'horaFimIntervalo')) {
        return;
      }
      
      document.getElementById('hiddenDiaIntervalo').value = dia;
      document.getElementById('hiddenInicioIntervalo').value = inicio + ':00';
      document.getElementById('hiddenFimIntervalo').value = fim + ':00';
      
      if (confirm(`Salvar intervalo para ${getNomeDia(dia)} das ${inicio} às ${fim}?`)) {
        document.getElementById('formIntervalo').submit();
      }
    }

    function salvarExcecao() {
      const data = document.getElementById('dataExcecao').value;
      const inicio = document.getElementById('horaInicioExcecao').value;
      const fim = document.getElementById('horaFimExcecao').value;
      const motivo = document.getElementById('motivoExcecao').value.trim();
      
      // Validações
      if (!data) {
        alert('Por favor, selecione uma data.');
        return;
      }
      
      if (!motivo) {
        alert('Por favor, informe o motivo da exceção.');
        return;
      }
      
      // Valida horário se preenchido
      if ((inicio && !fim) || (!inicio && fim)) {
        alert('Para exceção com horário, preencha ambos início e fim.');
        return;
      }
      
      if (inicio && fim && inicio >= fim) {
        alert('A hora de início deve ser anterior à hora de fim.');
        return;
      }
      
      document.getElementById('hiddenDataExcecao').value = data;
      document.getElementById('hiddenInicioExcecao').value = inicio ? inicio + ':00' : '';
      document.getElementById('hiddenFimExcecao').value = fim ? fim + ':00' : '';
      document.getElementById('hiddenMotivoExcecao').value = motivo;
      
      let mensagem = `Salvar exceção para ${formatarData(data)}?\nMotivo: ${motivo}`;
      if (inicio && fim) {
        mensagem += `\nHorário: ${inicio} às ${fim}`;
      } else {
        mensagem += `\nDia inteiro`;
      }
      
      if (confirm(mensagem)) {
        document.getElementById('formExcecao').submit();
      }
    }

    function excluirExcecao(idExcecao) {
      if (!confirm('Tem certeza que deseja excluir esta exceção?')) return;
      
      // Cria formulário dinâmico para exclusão
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'agenda_controller.php';
      form.style.display = 'none';
      
      const inputAction = document.createElement('input');
      inputAction.type = 'hidden';
      inputAction.name = 'action';
      inputAction.value = 'excluir_excecao';
      
      const inputId = document.createElement('input');
      inputId.type = 'hidden';
      inputId.name = 'id_excecao';
      inputId.value = idExcecao;
      
      form.appendChild(inputAction);
      form.appendChild(inputId);
      document.body.appendChild(form);
      form.submit();
    }

    function gerarSlots() {
      const duracao = document.getElementById('duracaoSlot').value;
      document.getElementById('hiddenDuracao').value = duracao;
      
      if (confirm(`Gerar slots de ${duracao} minutos para os próximos 60 dias?`)) {
        document.getElementById('formGerarSlots').submit();
      }
    }

    function limparSlots() {
      if (!confirm('Limpar todos os slots disponíveis?\nIsso não afeta agendamentos já confirmados.')) {
        return;
      }
      
      // Cria formulário dinâmico
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'agenda_controller.php';
      form.style.display = 'none';
      
      const inputAction = document.createElement('input');
      inputAction.type = 'hidden';
      inputAction.name = 'action';
      inputAction.value = 'limpar_slots';
      
      form.appendChild(inputAction);
      document.body.appendChild(form);
      form.submit();
    }

    // ========== FUNÇÕES AUXILIARES ==========

    function getNomeDia(valor) {
      const dias = {
        'segunda': 'Segunda-feira',
        'terca': 'Terça-feira',
        'quarta': 'Quarta-feira',
        'quinta': 'Quinta-feira',
        'sexta': 'Sexta-feira',
        'sabado': 'Sábado',
        'domingo': 'Domingo'
      };
      return dias[valor] || valor;
    }

    function formatarData(dataStr) {
      const data = new Date(dataStr + 'T00:00:00');
      return data.toLocaleDateString('pt-BR', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long',
        year: 'numeric'
      });
    }

    // Função para recarregar dados manualmente
    function recarregarDados() {
      document.querySelector('.status-bar').innerHTML = 
        '<strong>Status:</strong> Recarregando configurações...';
      carregarDadosIniciais();
    }

    // Adiciona botão de recarregar ao status bar
    setTimeout(function() {
      const statusBar = document.querySelector('.status-bar');
      if (statusBar) {
        const reloadBtn = document.createElement('button');
        reloadBtn.innerHTML = '↻';
        reloadBtn.style.cssText = `
          background: #3498db;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 5px 10px;
          cursor: pointer;
          margin-left: 10px;
          font-size: 12px;
        `;
        reloadBtn.title = 'Recarregar configurações';
        reloadBtn.onclick = recarregarDados;
        statusBar.appendChild(reloadBtn);
      }
    }, 1000);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configura√ß√£o de Agenda - Cl√≠nica Est√©tica</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    
    .container {
      display: flex;
      gap: 30px;
      margin-top: 20px;
    }
    
    .controls {
      width: 300px;
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
    }
    
    .controls h2 {
      margin-top: 20px;
      color: #333;
      font-size: 16px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    
    .controls label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    
    .controls select, .controls input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .controls button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    .controls button:hover {
      background: #45a049;
    }
    
    #calendar {
      flex: 1;
    }
    
    /* Estilos para os diferentes tipos de eventos */
    .disponibilidade {
      background-color: #4CAF50 !important;
      border-color: #4CAF50 !important;
    }
    
    .intervalo {
      background-color: #ff9800 !important;
      border-color: #ff9800 !important;
    }
    
    .excecao {
      background-color: #f44336 !important;
      border-color: #f44336 !important;
    }
    
    /* CSS APENAS DOS SLOTS - CORRIGIDO */
    .slot-disponivel {
      background-color: #2196F3 !important;
      border-color: #1976D2 !important;
      color: white !important;
      font-size: 11px !important;
      padding: 3px 6px !important;
      margin: 1px 0 !important;
      border-radius: 3px !important;
      border-left: 3px solid #0D47A1 !important;
      cursor: pointer;
    }
    
    .slot-disponivel:hover {
      background-color: #1976D2 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .slot-label {
      font-size: 10px;
      opacity: 0.9;
    }
    
    .slot-controls {
      background: #e8f5e9;
      padding: 15px;
      margin-top: 20px;
      border-radius: 6px;
      border: 1px solid #c8e6c9;
    }
    
    .btn-danger {
      background: #f44336 !important;
    }
    
    .btn-danger:hover {
      background: #d32f2f !important;
    }
  </style>
</head>
<body>
  <h1>Configura√ß√£o de Agenda - Cl√≠nica Est√©tica</h1>
  
  <div class="status-bar" style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
    <strong>Status:</strong> Carregando configura√ß√µes...
  </div>
  
  <div class="container">
    <div class="controls">
      <div class="slot-controls">
        <h2>Configura√ß√£o de Lacunas/Slots</h2>
        <label>Dura√ß√£o do Slot (minutos):</label>
        <select id="duracaoSlot">
          <option value="30">30 minutos</option>
          <option value="60" selected>60 minutos</option>
          <option value="90">90 minutos</option>
          <option value="120">120 minutos</option>
        </select>
        
        <!-- Bot√£o Gerar Slots com Formul√°rio -->
        <form method="POST" action="agenda_controller.php" id="formGerarSlots" style="display: inline;">
          <input type="hidden" name="action" value="gerar_slots">
          <input type="hidden" name="duracao" id="hiddenDuracao">
          <button type="button" onclick="gerarSlots()" style="margin-bottom: 10px;">Gerar Slots de Hor√°rios</button>
        </form>
        
        <!-- Bot√£o Limpar Slots com Formul√°rio -->
        <form method="POST" action="agenda_controller.php" style="display: inline;">
          <input type="hidden" name="action" value="limpar_slots">
          <button type="button" onclick="limparSlots()" style="background: #757575;">Limpar Slots</button>
        </form>
        
        <p><small>Slots s√£o gerados dentro das disponibilidades, exceto nos intervalos e exce√ß√µes.</small></p>
      </div>

      <h2>Disponibilidade</h2>
      <label>Dia da semana:</label>
      <select id="diaSemanaDisponibilidade">
        <option value="">Selecione um dia</option>
        <option value="segunda">Segunda-feira</option>
        <option value="terca">Ter√ßa-feira</option>
        <option value="quarta">Quarta-feira</option>
        <option value="quinta">Quinta-feira</option>
        <option value="sexta">Sexta-feira</option>
        <option value="sabado">S√°bado</option>
      </select>
      <label>Hora In√≠cio:</label>
      <input type="time" id="horaInicioDisponibilidade">
      <label>Hora Fim:</label>
      <input type="time" id="horaFimDisponibilidade">
      
      <!-- Formul√°rio para Disponibilidade -->
      <form method="POST" action="agenda_controller.php" id="formDisponibilidade" style="display: none;">
        <input type="hidden" name="action" value="salvar_config">
        <input type="hidden" name="tipo" value="disponibilidade">
        <input type="hidden" name="dia_semana" id="hiddenDiaDisponibilidade">
        <input type="hidden" name="horario_inicio" id="hiddenInicioDisponibilidade">
        <input type="hidden" name="horario_fim" id="hiddenFimDisponibilidade">
      </form>
      <button type="button" onclick="salvarDisponibilidade()">Adicionar/Alterar</button>

      <h2>Intervalo Fixo</h2>
      <label>Dia da semana:</label>
      <select id="diaSemanaIntervalo">
        <option value="">Selecione um dia</option>
        <option value="segunda">Segunda-feira</option>
        <option value="terca">Ter√ßa-feira</option>
        <option value="quarta">Quarta-feira</option>
        <option value="quinta">Quinta-feira</option>
        <option value="sexta">Sexta-feira</option>
        <option value="sabado">S√°bado</option>
      </select>
      <label>Hora In√≠cio:</label>
      <input type="time" id="horaInicioIntervalo">
      <label>Hora Fim:</label>
      <input type="time" id="horaFimIntervalo">
      
      <!-- Formul√°rio para Intervalo -->
      <form method="POST" action="agenda_controller.php" id="formIntervalo" style="display: none;">
        <input type="hidden" name="action" value="salvar_config">
        <input type="hidden" name="tipo" value="intervalo">
        <input type="hidden" name="dia_semana" id="hiddenDiaIntervalo">
        <input type="hidden" name="horario_inicio" id="hiddenInicioIntervalo">
        <input type="hidden" name="horario_fim" id="hiddenFimIntervalo">
      </form>
      <button type="button" onclick="salvarIntervalo()">Adicionar/Alterar</button>

      <h2>Exce√ß√µes</h2>
      <label>Data:</label>
      <input type="date" id="dataExcecao">
      <label>Hora In√≠cio (opcional):</label>
      <input type="time" id="horaInicioExcecao">
      <label>Hora Fim (opcional):</label>
      <input type="time" id="horaFimExcecao">
      <label>Motivo:</label>
      <input type="text" id="motivoExcecao" placeholder="Ex: Feriado">
      
      <!-- Formul√°rio para Exce√ß√£o -->
      <form method="POST" action="agenda_controller.php" id="formExcecao" style="display: none;">
        <input type="hidden" name="action" value="salvar_excecao">
        <input type="hidden" name="data_excecao" id="hiddenDataExcecao">
        <input type="hidden" name="horario_inicio" id="hiddenInicioExcecao">
        <input type="hidden" name="horario_fim" id="hiddenFimExcecao">
        <input type="hidden" name="motivo" id="hiddenMotivoExcecao">
      </form>
      <button type="button" onclick="salvarExcecao()">Adicionar Exce√ß√£o</button>
    </div>
    <div id="calendar"></div>
  </div>

  <script>
    // Vari√°veis globais
    let disponibilidades = [];
    let intervalos = [];
    let excecoes = [];
    let slots = [];
    let calendar;

    document.addEventListener('DOMContentLoaded', function() {
      // Configura data atual no campo de exce√ß√£o
      const hoje = new Date();
      document.getElementById('dataExcecao').value = hoje.toISOString().split('T')[0];
      
      // Inicializa o calend√°rio primeiro
      inicializarCalendario();
      
      // Depois carrega os dados
      carregarDadosIniciais();
    });

    // ========== CARREGAR DADOS ==========

    async function carregarDadosIniciais() {
      try {
        // Carrega disponibilidades
        const response1 = await fetch('carregar_dados.php?tipo=disponibilidade&_=' + Date.now());
        const disponibilidadeData = await response1.text();
        disponibilidades = extrairDadosDeScript(disponibilidadeData) || [];
        
        // Carrega intervalos
        const response2 = await fetch('carregar_dados.php?tipo=intervalo&_=' + Date.now());
        const intervaloData = await response2.text();
        intervalos = extrairDadosDeScript(intervaloData) || [];
        
        // Carrega exce√ß√µes
        const response3 = await fetch('carregar_dados.php?tipo=excecoes&_=' + Date.now());
        const excecaoData = await response3.text();
        excecoes = extrairDadosDeScript(excecaoData) || [];
        
        // Carrega slots
        await carregarSlots();
        
        console.log('Dados carregados:', { 
          disponibilidades: disponibilidades.length, 
          intervalos: intervalos.length, 
          excecoes: excecoes.length,
          slots: slots.length
        });
        
        // Atualiza status
        atualizarStatusBar();
        
        // Atualiza os eventos no calend√°rio
        atualizarEventosCalendario();
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        document.querySelector('.status-bar').innerHTML = 
          `<strong>Erro:</strong> N√£o foi poss√≠vel carregar configura√ß√µes. Tente recarregar a p√°gina.`;
      }
    }

    async function carregarSlots() {
      try {
        // Carrega slots para os pr√≥ximos 30 dias
        const hoje = new Date();
        const dataFim = new Date();
        dataFim.setDate(hoje.getDate() + 30);
        
        const dataInicioStr = hoje.toISOString().split('T')[0];
        const dataFimStr = dataFim.toISOString().split('T')[0];
        
        const response = await fetch(`carregar_slots.php?data_inicio=${dataInicioStr}&data_fim=${dataFimStr}&_=${Date.now()}`);
        const slotsData = await response.text();
        
        // Executa o script para definir window.slots
        eval(slotsData);
        
        // Atualiza a vari√°vel global
        slots = window.slots || [];
        
        console.log(`‚úÖ ${slots.length} slots carregados de ${dataInicioStr} at√© ${dataFimStr}`);
        
      } catch (error) {
        console.error('Erro ao carregar slots:', error);
        slots = [];
      }
    }

    function atualizarStatusBar() {
      const totalSlots = slots.length;
      const disponiveis = disponibilidades.length;
      const intervalosCount = intervalos.length;
      const excecoesCount = excecoes.length;
      
      let statusHTML = `<strong>Status:</strong> ${disponiveis} disponibilidades, `;
      statusHTML += `${intervalosCount} intervalos, ${excecoesCount} exce√ß√µes`;
      
      if (totalSlots > 0) {
        statusHTML += `, ${totalSlots} slots`;
      }
      
      // Se houver par√¢metro de slots gerados na URL
      const urlParams = new URLSearchParams(window.location.search);
      const slotsGerados = urlParams.get('slots_gerados');
      
      if (slotsGerados) {
        statusHTML += ` <span style="color: #4CAF50; font-weight: bold;">(${slotsGerados} novos slots gerados!)</span>`;
        
        // Remove o par√¢metro da URL
        setTimeout(() => {
          window.history.replaceState({}, document.title, window.location.pathname);
        }, 3000);
      }
      
      document.querySelector('.status-bar').innerHTML = statusHTML;
    }

    function extrairDadosDeScript(scriptContent) {
      // Procura por window.nomeArray = [...];
      const match = scriptContent.match(/window\.\w+\s*=\s*(\[.*?\])/s);
      if (match) {
        try {
          // Remove coment√°rios e eval
          const cleanScript = match[1].replace(/\n/g, '');
          return eval('(' + cleanScript + ')');
        } catch (e) {
          console.error('Erro ao parsear dados:', e);
          return [];
        }
      }
      return [];
    }

    // ========== INICIALIZAR CALEND√ÅRIO ==========

    function inicializarCalendario() {
      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'timeGridWeek',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'pt-br',
        editable: false,
        selectable: false,
        slotDuration: '00:30:00',
        slotLabelInterval: '01:00',
        allDaySlot: false,
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        height: 650,
        events: [],
        
        eventClick: function(info) {
          const tipo = info.event.extendedProps.tipo;
          
          if (tipo === 'excecao') {
            if (confirm('Deseja excluir esta exce√ß√£o?')) {
              excluirExcecao(info.event.id);
            }
          } else if (tipo === 'slot') {
            const id_slot = info.event.extendedProps.id_slot;
            const duracao = info.event.extendedProps.duracao || 60;
            const data = info.event.start.toLocaleDateString('pt-BR');
            const hora = info.event.start.toLocaleTimeString('pt-BR', { 
              hour: '2-digit', 
              minute: '2-digit' 
            });
            
            const mensagem = `üìÖ Slot Dispon√≠vel\n\n` +
                            `Data: ${data}\n` +
                            `Hor√°rio: ${hora}\n` +
                            `Dura√ß√£o: ${duracao} minutos\n\n` +
                            `ID do Slot: ${id_slot}\n\n` +
                            `O que deseja fazer?`;
            
            const acao = confirm(`${mensagem}\n\nClique em OK para agendar neste slot\nou em Cancelar para voltar`);
            
            if (acao) {
              // Aqui voc√™ pode integrar com o sistema de agendamento
              alert(`üöÄ Redirecionando para agendamento no slot ${id_slot}...`);
              // window.location.href = `agendar.php?slot_id=${id_slot}`;
            }
          }
        },
        
        // Tooltip para eventos
        eventDidMount: function(info) {
          const tipo = info.event.extendedProps.tipo;
          const descricao = info.event.extendedProps.descricao || '';
          
          // Adiciona tooltip
          if (descricao) {
            info.el.title = descricao;
          }
          
          // Estilo espec√≠fico para slots
          if (tipo === 'slot') {
            info.el.style.fontSize = '11px';
            info.el.style.padding = '3px 6px';
            info.el.style.margin = '1px 0';
            info.el.style.borderRadius = '3px';
            info.el.style.borderLeft = '3px solid #0D47A1';
          }
        }
      });
      
      calendar.render();
    }

    function atualizarEventosCalendario() {
      if (!calendar) return;
      
      calendar.removeAllEvents();
      const eventos = [];
      
      // Mapeia dias da semana para n√∫meros do FullCalendar (0=Domingo, 1=Segunda...)
      const diasMap = {
        'segunda': 1,
        'terca': 2,
        'quarta': 3,
        'quinta': 4,
        'sexta': 5,
        'sabado': 6,
        'domingo': 0
      };
      
      // Adiciona disponibilidades
      disponibilidades.forEach(d => {
        const diaNumero = diasMap[d.dia_semana.toLowerCase()] || parseInt(d.dia_semana);
        const inicio = d.horario_inicio ? d.horario_inicio.substring(0, 5) : '';
        const fim = d.horario_fim ? d.horario_fim.substring(0, 5) : '';
        
        eventos.push({
          daysOfWeek: [diaNumero],
          startTime: inicio,
          endTime: fim,
          title: `Dispon√≠vel (${inicio} - ${fim})`,
          className: 'disponibilidade',
          tipo: 'disponibilidade',
          color: '#4CAF50',
          extendedProps: {
            descricao: `Hor√°rio dispon√≠vel para agendamento`
          }
        });
      });
      
      // Adiciona intervalos
      intervalos.forEach(i => {
        const diaNumero = diasMap[i.dia_semana.toLowerCase()] || parseInt(i.dia_semana);
        const inicio = i.horario_inicio ? i.horario_inicio.substring(0, 5) : '';
        const fim = i.horario_fim ? i.horario_fim.substring(0, 5) : '';
        
        eventos.push({
          daysOfWeek: [diaNumero],
          startTime: inicio,
          endTime: fim,
          title: `Intervalo (${inicio} - ${fim})`,
          className: 'intervalo',
          tipo: 'intervalo',
          color: '#ff9800',
          extendedProps: {
            descricao: `Intervalo fixo - n√£o dispon√≠vel para agendamento`
          }
        });
      });
      
      // Adiciona exce√ß√µes
      excecoes.forEach(e => {
        const isTodoDia = !e.horario_inicio && !e.horario_fim;
        const inicio = e.horario_inicio ? e.horario_inicio.substring(0, 5) : '';
        const fim = e.horario_fim ? e.horario_fim.substring(0, 5) : '';
        
        eventos.push({
          id: e.id_excecao ? e.id_excecao.toString() : '',
          start: isTodoDia ? e.data_excecao : `${e.data_excecao}T${inicio}`,
          end: isTodoDia ? e.data_excecao : `${e.data_excecao}T${fim}`,
          title: `Exce√ß√£o: ${e.motivo}` + (isTodoDia ? '' : ` (${inicio} - ${fim})`),
          className: 'excecao',
          tipo: 'excecao',
          color: '#f44336',
          allDay: isTodoDia,
          extendedProps: {
            descricao: `Exce√ß√£o: ${e.motivo}`
          }
        });
      });
      
      // Adiciona slots
      slots.forEach(s => {
        const inicio = s.horario_inicio ? s.horario_inicio.substring(0, 5) : '';
        const fim = s.horario_fim ? s.horario_fim.substring(0, 5) : '';
        const duracao = s.duracao_minutos || 60;
        
        eventos.push({
          id: 'slot_' + s.id_slot,
          start: `${s.data_slot}T${inicio}`,
          end: `${s.data_slot}T${fim}`,
          title: `Slot ${duracao}min`,
          className: 'slot-disponivel',
          tipo: 'slot',
          color: '#2196F3',
          extendedProps: {
            descricao: `Slot dispon√≠vel para agendamento (${duracao} minutos)`,
            duracao: duracao,
            id_slot: s.id_slot
          }
        });
      });
      
      // Adiciona todos os eventos
      eventos.forEach(evento => {
        try {
          calendar.addEvent(evento);
        } catch (e) {
          console.error('Erro ao adicionar evento:', evento, e);
        }
      });
      
      // Atualiza o calend√°rio
      calendar.render();
      
      console.log(`üìä Calend√°rio atualizado com ${eventos.length} eventos (${slots.length} slots)`);
    }

    // ========== VALIDA√á√ïES ==========

    function validarHorario(idInicio, idFim) {
      const inicio = document.getElementById(idInicio).value;
      const fim = document.getElementById(idFim).value;
      
      if (inicio && fim && inicio >= fim) {
        alert('A hora de in√≠cio deve ser anterior √† hora de fim.');
        return false;
      }
      return true;
    }

    // ========== FUN√á√ïES PARA SALVAR ==========

    function salvarDisponibilidade() {
      const diaSelect = document.getElementById('diaSemanaDisponibilidade');
      const dia = diaSelect.value;
      const inicio = document.getElementById('horaInicioDisponibilidade').value;
      const fim = document.getElementById('horaFimDisponibilidade').value;
      
      console.log('DEBUG - salvarDisponibilidade:');
      console.log('Dia selecionado:', dia);
      console.log('Hor√°rio in√≠cio:', inicio);
      console.log('Hor√°rio fim:', fim);
      
      // Valida√ß√µes
      if (!dia || dia === "") {
        alert('Por favor, selecione um dia da semana.');
        diaSelect.focus();
        return;
      }
      
      if (!inicio || !fim) {
        alert('Por favor, preencha ambos os hor√°rios.');
        return;
      }
      
      if (inicio >= fim) {
        alert('A hora de in√≠cio deve ser anterior √† hora de fim.');
        return;
      }
      
      // PREENCHER OS CAMPOS HIDDEN
      const hiddenDia = document.getElementById('hiddenDiaDisponibilidade');
      const hiddenInicio = document.getElementById('hiddenInicioDisponibilidade');
      const hiddenFim = document.getElementById('hiddenFimDisponibilidade');
      
      hiddenDia.value = dia;
      hiddenInicio.value = inicio.includes(':') ? inicio : inicio + ':00';
      if (!hiddenInicio.value.includes(':')) {
        hiddenInicio.value = hiddenInicio.value + ':00';
      }
      
      hiddenFim.value = fim.includes(':') ? fim : fim + ':00';
      if (!hiddenFim.value.includes(':')) {
        hiddenFim.value = hiddenFim.value + ':00';
      }
      
      console.log('Valores hidden que ser√£o enviados:');
      console.log('Dia:', hiddenDia.value);
      console.log('In√≠cio:', hiddenInicio.value);
      console.log('Fim:', hiddenFim.value);
      
      if (confirm(`Salvar disponibilidade para ${getNomeDia(dia)} das ${inicio} √†s ${fim}?`)) {
        document.getElementById('formDisponibilidade').submit();
      }
    }

    function salvarIntervalo() {
      const diaSelect = document.getElementById('diaSemanaIntervalo');
      const dia = diaSelect.value;
      const inicio = document.getElementById('horaInicioIntervalo').value;
      const fim = document.getElementById('horaFimIntervalo').value;
      
      console.log('DEBUG - salvarIntervalo:');
      console.log('Dia selecionado:', dia);
      console.log('Hor√°rio in√≠cio:', inicio);
      console.log('Hor√°rio fim:', fim);
      
      // Valida√ß√µes
      if (!dia || dia === "") {
        alert('Por favor, selecione um dia da semana.');
        diaSelect.focus();
        return;
      }
      
      if (!inicio || !fim) {
        alert('Por favor, preencha ambos os hor√°rios.');
        return;
      }
      
      if (inicio >= fim) {
        alert('A hora de in√≠cio deve ser anterior √† hora de fim.');
        return;
      }
      
      // PREENCHER OS CAMPOS HIDDEN
      const hiddenDia = document.getElementById('hiddenDiaIntervalo');
      const hiddenInicio = document.getElementById('hiddenInicioIntervalo');
      const hiddenFim = document.getElementById('hiddenFimIntervalo');
      
      hiddenDia.value = dia;
      hiddenInicio.value = inicio.includes(':') ? inicio : inicio + ':00';
      if (!hiddenInicio.value.includes(':')) {
        hiddenInicio.value = hiddenInicio.value + ':00';
      }
      
      hiddenFim.value = fim.includes(':') ? fim : fim + ':00';
      if (!hiddenFim.value.includes(':')) {
        hiddenFim.value = hiddenFim.value + ':00';
      }
      
      console.log('Valores hidden que ser√£o enviados:');
      console.log('Dia:', hiddenDia.value);
      console.log('In√≠cio:', hiddenInicio.value);
      console.log('Fim:', hiddenFim.value);
      
      if (confirm(`Salvar intervalo para ${getNomeDia(dia)} das ${inicio} √†s ${fim}?`)) {
        document.getElementById('formIntervalo').submit();
      }
    }

    function salvarExcecao() {
      const data = document.getElementById('dataExcecao').value;
      const inicio = document.getElementById('horaInicioExcecao').value;
      const fim = document.getElementById('horaFimExcecao').value;
      const motivo = document.getElementById('motivoExcecao').value.trim();
      
      // Valida√ß√µes
      if (!data) {
        alert('Por favor, selecione uma data.');
        return;
      }
      
      if (!motivo) {
        alert('Por favor, informe o motivo da exce√ß√£o.');
        return;
      }
      
      // Valida hor√°rio se preenchido
      if ((inicio && !fim) || (!inicio && fim)) {
        alert('Para exce√ß√£o com hor√°rio, preencha ambos in√≠cio e fim.');
        return;
      }
      
      if (inicio && fim && inicio >= fim) {
        alert('A hora de in√≠cio deve ser anterior √† hora de fim.');
        return;
      }
      
      document.getElementById('hiddenDataExcecao').value = data;
      document.getElementById('hiddenInicioExcecao').value = inicio ? inicio + ':00' : '';
      document.getElementById('hiddenFimExcecao').value = fim ? fim + ':00' : '';
      document.getElementById('hiddenMotivoExcecao').value = motivo;
      
      let mensagem = `Salvar exce√ß√£o para ${formatarData(data)}?\nMotivo: ${motivo}`;
      if (inicio && fim) {
        mensagem += `\nHor√°rio: ${inicio} √†s ${fim}`;
      } else {
        mensagem += `\nDia inteiro`;
      }
      
      if (confirm(mensagem)) {
        document.getElementById('formExcecao').submit();
      }
    }

    function excluirExcecao(idExcecao) {
      if (!confirm('Tem certeza que deseja excluir esta exce√ß√£o?')) return;
      
      // Cria formul√°rio din√¢mico para exclus√£o
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'agenda_controller.php';
      form.style.display = 'none';
      
      const inputAction = document.createElement('input');
      inputAction.type = 'hidden';
      inputAction.name = 'action';
      inputAction.value = 'excluir_excecao';
      
      const inputId = document.createElement('input');
      inputId.type = 'hidden';
      inputId.name = 'id_excecao';
      inputId.value = idExcecao;
      
      form.appendChild(inputAction);
      form.appendChild(inputId);
      document.body.appendChild(form);
      form.submit();
    }

    function gerarSlots() {
      const duracao = document.getElementById('duracaoSlot').value;
      document.getElementById('hiddenDuracao').value = duracao;
      
      const confirmMsg = `Gerar slots de ${duracao} minutos?\n\n` +
                        `Isso ir√°:\n` +
                        `1. Remover todos os slots existentes\n` +
                        `2. Gerar novos slots para os pr√≥ximos 60 dias\n` +
                        `3. Considerar disponibilidades, intervalos e exce√ß√µes\n\n` +
                        `Continuar?`;
      
      if (confirm(confirmMsg)) {
        // Mostra loading
        document.querySelector('.status-bar').innerHTML = 
          '<strong>Status:</strong> ‚è≥ Gerando slots...';
        
        document.getElementById('formGerarSlots').submit();
      }
    }

    function limparSlots() {
      if (!confirm('‚ö†Ô∏è Limpar TODOS os slots dispon√≠veis?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }
      
      // Cria formul√°rio din√¢mico
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'agenda_controller.php';
      form.style.display = 'none';
      
      const inputAction = document.createElement('input');
      inputAction.type = 'hidden';
      inputAction.name = 'action';
      inputAction.value = 'limpar_slots';
      
      form.appendChild(inputAction);
      document.body.appendChild(form);
      form.submit();
    }

    // ========== FUN√á√ïES AUXILIARES ==========

    function getNomeDia(valor) {
      const dias = {
        'segunda': 'Segunda-feira',
        'terca': 'Ter√ßa-feira',
        'quarta': 'Quarta-feira',
        'quinta': 'Quinta-feira',
        'sexta': 'Sexta-feira',
        'sabado': 'S√°bado',
        'domingo': 'Domingo'
      };
      return dias[valor] || valor;
    }

    function formatarData(dataStr) {
      const data = new Date(dataStr + 'T00:00:00');
      return data.toLocaleDateString('pt-BR', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long',
        year: 'numeric'
      });
    }

    // Fun√ß√£o para recarregar dados manualmente
    function recarregarDados() {
      document.querySelector('.status-bar').innerHTML = 
        '<strong>Status:</strong> ‚è≥ Recarregando configura√ß√µes e slots...';
      
      // Limpa arrays
      disponibilidades = [];
      intervalos = [];
      excecoes = [];
      slots = [];
      
      // Recarrega tudo
      carregarDadosIniciais();
    }

    // Adiciona bot√£o de recarregar ao status bar
    setTimeout(function() {
      const statusBar = document.querySelector('.status-bar');
      if (statusBar) {
        const reloadBtn = document.createElement('button');
        reloadBtn.innerHTML = '‚Üª';
        reloadBtn.style.cssText = `
          background: #3498db;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 5px 10px;
          cursor: pointer;
          margin-left: 10px;
          font-size: 12px;
        `;
        reloadBtn.title = 'Recarregar configura√ß√µes';
        reloadBtn.onclick = recarregarDados;
        statusBar.appendChild(reloadBtn);
      }
    }, 1000);
  </script>
</body>
</html> 